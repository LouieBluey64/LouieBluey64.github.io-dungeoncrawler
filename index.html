<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Crypt Unending ‚Äî D‚ÄëPad Build</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<style>
  :root{
    --bg:#0b0b0e; --floor:#17181d; --grout:#0f1016; --wall:#1b1b21; --wallHi:#25252e; --wallSd:#0d0e12;
    --torch:#ffbd6a; --torch2:#ff9e42; --pool1:#0a2233; --pool2:#184a6e; --drip:#1a2533;
    --bone:#e0dccf;
  }
  *{ -webkit-tap-highlight-color:transparent; -webkit-user-select:none; user-select:none; touch-action:manipulation; }
  html,body{margin:0;height:100%;background:var(--bg);color:#eee;font-family:ui-rounded,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  #cv{position:fixed; inset:0; width:100dvw; height:100dvh; image-rendering:pixelated; background:var(--bg); touch-action:none}

  /* HUD */
  #hud{position:fixed; inset:0; pointer-events:none}
  .bar{height:10px;width:180px;background:#111;border:1px solid #2b2b33;border-radius:4px;position:absolute}
  .fill{position:absolute;inset:0;width:100%}
  #hpT{left:10px;top:8px;font-weight:900}
  #hpB{left:84px;top:8px}.hpF{background:linear-gradient(180deg,#c23,#821b25)}
  #enB{left:84px;top:24px}.enF{background:linear-gradient(180deg,#4bb7ff,#2a6fa3)}
  #huB{left:84px;top:40px}.huF{background:linear-gradient(180deg,#7bbd4a,#46752c)}
  #roomT{position:absolute;right:10px;top:8px;font-weight:900;color:#cfd2e6}
  #coinsT{position:absolute;right:10px;top:26px;color:#ffdf84;font-weight:900}

  /* Buttons */
  .pad{position:absolute;pointer-events:auto}
  .btn{width:64px;height:64px;border-radius:12px;background:rgba(255,255,255,.08);border:1px solid #3a3a45;color:#e8e8f0;display:flex;align-items:center;justify-content:center;font-size:26px}

  /* Right column */
  #btnMelee{right:12px;bottom:16px}
  #btnRanged{right:12px;bottom:92px}
  #btnDash{right:12px;bottom:168px}
  #btnInteract{right:92px;bottom:132px}
  #btnInv{right:92px;bottom:56px}

  /* D‚ÄëPad (left) */
  #dpad{left:16px;bottom:16px;width:192px;height:192px;pointer-events:none;position:absolute}
  .dkey{position:absolute;pointer-events:auto}
  #up{left:64px;top:0}
  #down{left:64px;bottom:0}
  #left{left:0;top:64px}
  #right{right:0;top:64px}
  #msg{position:fixed;left:50%;top:10px;transform:translateX(-50%);background:#111a;border:1px solid #2a2a33;border-radius:10px;padding:.35rem .7rem;display:none}

  #panel{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center}
  .card{background:linear-gradient(180deg,#15151a,#0f0f14);border:1px solid #2a2a33;border-radius:14px;padding:16px;max-width:640px;color:#ddd}
  .choices{display:flex;flex-wrap:wrap;gap:.6rem;margin-top:.6rem}
  .choice{pointer-events:auto;padding:.5rem .7rem;border:1px solid #3a3a45;border-radius:10px;background:#141418;cursor:pointer}
  #invGrid{display:grid;grid-template-columns:repeat(5,44px);gap:6px;margin-top:.6rem}
  .slot{width:44px;height:44px;background:#0d0d12;border:1px solid #2b2b33;border-radius:8px;display:flex;align-items:center;justify-content:center}
</style>
</head>
<body>
<canvas id="cv" width="320" height="180"></canvas>

<div id="hud">
  <div id="hpT">‚ô• <span id="hpVal">10</span>/10</div>
  <div id="hpB" class="bar"><div id="hpF" class="fill hpF"></div></div>
  <div id="enB" class="bar"><div id="enF" class="fill enF"></div></div>
  <div id="huB" class="bar"><div id="huF" class="fill huF"></div></div>
  <div id="roomT">Room 1</div>
  <div id="coinsT">ü™ô 0</div>

  <!-- Right controls -->
  <button id="btnDash" class="pad btn" aria-label="Dash">üí®</button>
  <button id="btnRanged" class="pad btn" aria-label="Ranged">üèπ</button>
  <button id="btnMelee" class="pad btn" aria-label="Melee">üó°Ô∏è</button>
  <button id="btnInteract" class="pad btn" aria-label="Interact">‚úã</button>
  <button id="btnInv" class="pad btn" aria-label="Inventory">üéí</button>

  <!-- D‚ÄëPad -->
  <div id="dpad">
    <button id="up" class="btn dkey">‚ñ≤</button>
    <button id="down" class="btn dkey">‚ñº</button>
    <button id="left" class="btn dkey">‚óÄ</button>
    <button id="right" class="btn dkey">‚ñ∂</button>
  </div>
</div>

<div id="msg"></div>
<div id="panel"><div class="card" id="panelC"></div></div>

<script>
/* ---------- helpers / canvas ---------- */
const cv=document.getElementById('cv'), cx=cv.getContext('2d');
const rand=(a,b)=>Math.random()*(b-a)+a, rint=(a,b)=>Math.floor(rand(a,b+1)), clamp=(v,a,b)=>v<a?a:(v>b?b:v), chance=p=>Math.random()<p;
let W=cv.width,H=cv.height,SCALE=3; const css=n=>getComputedStyle(document.documentElement).getPropertyValue(n);
function fit(){const vw=innerWidth,vh=innerHeight;SCALE=Math.max(1,Math.floor(Math.min(vw/W,vh/H)));cv.style.width=W*SCALE+'px';cv.style.height=H*SCALE+'px';}
addEventListener('resize',fit); addEventListener('orientationchange',fit); fit();

/* ---------- audio ---------- */
const SFX=(()=>{const C=new (window.AudioContext||window.webkitAudioContext)();let ok=false;
async function start(){if(C.state!=='running'){try{await C.resume();}catch{}}ok=true;}
function blip(f=500,d=0.07,v=0.2,t='square'){if(!ok)return;const o=C.createOscillator(),g=C.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g);g.connect(C.destination);const n=C.currentTime;o.start(n);g.gain.exponentialRampToValueAtTime(0.0001,n+d);o.stop(n+d+0.02);}
return{start,hit:()=>blip(520,0.06,0.22,'square'),dash:()=>blip(140,0.1,0.25,'sine'),hurt:()=>blip(160,0.12,0.3,'triangle'),pick:()=>blip(880,0.07,0.22,'square'),coin:()=>blip(740,0.06,0.22,'square'),heal:()=>blip(900,0.1,0.25,'sine')};})();

/* ---------- state ---------- */
const TILE=16,RW=22,RH=14;
const T={FLOOR:0,WALL:1,TORCH:2,POOL:3,DRIP:4,DOOR:5,CHEST:7,LEVER:8,SECRETD:9,ANVIL:10,TRADER:11};
const EN={SLIME:'slime',SKEL:'skeleton',ARCH:'archer',BRUTE:'brute',BAT:'bat'};
const IT={FOOD:'food',SWORD:'sword',XBOW:'xbow',POT:'pot',SHIELD:'shield',RELIC:'relic'};
let room=1, map=[], ents=[], coins=0;

/* player */
const player={x:RW/2,y:RH/2,spd:3.0,base:3.0,hp:10,hpMax:10,energy:100,energyMax:100,hunger:10,hungerMax:10,face:[1,0],dashCd:0,melee:false,meleeDur:0,ranged:false,rangedDur:0,inv:[]};
function equipSword(d=30){player.melee=true;player.meleeDur=d;}
function equipBow(d=20){player.ranged=true;player.rangedDur=d;}

/* ---------- HUD refs ---------- */
const hpVal=document.getElementById('hpVal'), hpF=document.getElementById('hpF'), enF=document.getElementById('enF'), huF=document.getElementById('huF');
const roomT=document.getElementById('roomT'), coinsT=document.getElementById('coinsT');
const msg=document.getElementById('msg'); let msgTo=0; function toast(t,ms=1200){ msg.textContent=t; msg.style.display='block'; clearTimeout(msgTo); msgTo=setTimeout(()=>msg.style.display='none',ms); }

/* ---------- INPUT: D‚ÄëPad ---------- */
const held={up:false,down:false,left:false,right:false};
function hold(id,flag){
  const el=document.getElementById(id);
  el.addEventListener('touchstart',e=>{e.preventDefault(); held[flag]=true;},{passive:false});
  el.addEventListener('touchend',e=>{e.preventDefault(); held[flag]=false;},{passive:false});
  el.addEventListener('touchcancel',()=>{held[flag]=false;});
}
hold('up','up'); hold('down','down'); hold('left','left'); hold('right','right');

document.getElementById('btnDash').addEventListener('touchstart',e=>{e.preventDefault(); doDash();},{passive:false});
document.getElementById('btnMelee').addEventListener('touchstart',e=>{e.preventDefault(); melee();},{passive:false});
document.getElementById('btnRanged').addEventListener('touchstart',e=>{e.preventDefault(); ranged();},{passive:false});
document.getElementById('btnInteract').addEventListener('touchstart',e=>{e.preventDefault(); interact();},{passive:false});
document.getElementById('btnInv').addEventListener('touchstart',e=>{e.preventDefault(); openInventory();},{passive:false});

/* block double‚Äëtap zoom (fast combos) */
let lastTap=0; document.addEventListener('touchend',e=>{const n=Date.now(); if(n-lastTap<300) e.preventDefault(); lastTap=n;},{passive:false});

/* ---------- generation ---------- */
function regen(){
  map=Array.from({length:RH},()=>Array(RW).fill(T.FLOOR));
  for(let y=0;y<RH;y++)for(let x=0;x<RW;x++) if(x===0||y===0||x===RW-1||y===RH-1) map[y][x]=T.WALL;
  for(let i=0;i<rint(20,36);i++){ const x=rint(2,RW-3),y=rint(2,RH-3); map[y][x]=Math.random()<.7?T.WALL:T.DRIP; }
  for(let i=0;i<rint(4,6);i++){ const s=rint(0,3); let x=1,y=1; if(s===0){x=rint(3,RW-4);y=1}else if(s===1){x=rint(3,RW-4);y=RH-2}else if(s===2){x=1;y=rint(3,RH-4)}else{x=RW-2;y=rint(3,RH-4)} map[y][x]=T.TORCH; }
  const s=rint(0,3); if(s===0) map[0][rint(4,RW-5)]=T.DOOR; else if(s===1) map[RH-1][rint(4,RW-5)]=T.DOOR; else if(s===2) map[rint(4,RH-5)][0]=T.DOOR; else map[rint(4,RH-5)][RW-1]=T.DOOR;
  if(room%10===0){ map[rint(3,RH-4)][rint(3,RW-4)]=T.POOL; map[rint(4,RH-5)][rint(4,RW-5)]=T.ANVIL; } else if(chance(.25)) map[rint(3,RH-4)][rint(3,RW-4)]=T.POOL;
  if(chance(.35)){ const sx=rint(3,RW-4),sy=rint(3,RH-4); map[sy][sx]=T.SECRETD; const lx=Math.max(2,Math.min(RW-3,sx+rint(-3,3))), ly=Math.max(2,Math.min(RH-3,sy+rint(-3,3))); map[ly][lx]=T.LEVER; }
  if(chance(.4)) map[rint(3,RH-4)][rint(3,RW-4)]=T.CHEST;
  if(chance(.10)) map[rint(3,RH-4)][rint(3,RW-4)]=T.TRADER;
  const depth=Math.min(1,(room-1)/120), n=rint(1,2+Math.round(depth*4));
  for(let i=0;i<n;i++) spawnEnemy(pickEnemy(depth));
  player.x=RW/2; player.y=RH/2;
}
function pickEnemy(d){ const bag=[[EN.SLIME,.45-.3*d],[EN.SKEL,.35+.2*d],[EN.ARCH,.1+.1*d],[EN.BAT,.05+.1*d],[EN.BRUTE,.05+.12*d]].filter(b=>b[1]>0.001); let s=bag.reduce((a,b)=>a+b[1],0), r=Math.random()*s; for(const [k,w] of bag){ if((r-=w)<=0) return k; } return EN.SLIME; }
function spawnEnemy(kind){ const e={kind,enemy:true,x:rint(2,RW-3),y:rint(2,RH-3),hp:1,spd:.5,cd:0}; if(kind===EN.SLIME){e.hp=1;e.spd=.45} if(kind===EN.SKEL){e.hp=3;e.spd=.6} if(kind===EN.ARCH){e.hp=2;e.spd=.55;e.ranged=true} if(kind===EN.BAT){e.hp=1;e.spd=.9;e.fly=true} if(kind===EN.BRUTE){e.hp=5;e.spd=.45;e.dmg=2} ents.push(e); }
function tileAt(x,y){ if(y<0||y>=RH||x<0||x>=RW) return T.WALL; return map[y][x]; }
function walkable(tx,ty){ const t=tileAt(tx,ty); return t!==T.WALL && t!==T.SECRETD; }

/* ---------- draw (direct to main canvas) ---------- */
function drawWorld(){
  const camX=player.x*TILE - W/2, camY=player.y*TILE - H/2;
  cx.imageSmoothingEnabled=false;
  cx.fillStyle=css('--bg'); cx.fillRect(0,0,W,H);

  for(let y=0;y<RH;y++)for(let x=0;x<RW;x++){
    const t=map[y][x], px=Math.floor(x*TILE - camX), py=Math.floor(y*TILE - camY);
    cx.fillStyle=css('--floor'); cx.fillRect(px,py,TILE,TILE);
    cx.fillStyle=css('--grout'); if(((x^y)&3)===0) cx.fillRect(px+TILE-2,py+TILE-2,1,1);
    if(t===T.TORCH){ cx.globalAlpha=.22; cx.fillStyle=css('--torch'); cx.fillRect(px-8,py-8,TILE+16,TILE+16); cx.globalAlpha=1; }
  }
  for(let y=0;y<RH;y++)for(let x=0;x<RW;x++){
    const t=map[y][x], px=Math.floor(x*TILE - camX), py=Math.floor(y*TILE - camY);
    if(t===T.WALL||t===T.SECRETD){ cx.fillStyle=css('--wall'); cx.fillRect(px,py,TILE,TILE); cx.fillStyle=css('--wallHi'); cx.fillRect(px,py,TILE,3); cx.fillStyle=css('--wallSd'); cx.fillRect(px,py+TILE-3,TILE,3); cx.fillStyle=css('--grout'); cx.fillRect(px+8,py,1,TILE); }
    if(t===T.DRIP){ cx.fillStyle=css('--drip'); cx.fillRect(px+9,py+2,2,TILE-4); }
    if(t===T.POOL){ cx.fillStyle=css('--pool1'); cx.fillRect(px+2,py+3,12,11); cx.fillStyle=css('--pool2'); cx.fillRect(px+3,py+6,10,6); }
    if(t===T.CHEST){ cx.fillStyle='#3a2816'; cx.fillRect(px+3,py+8,10,6); cx.fillStyle='#714b22'; cx.fillRect(px+3,py+5,10,4); cx.fillStyle='#cfa85b'; cx.fillRect(px+7,py+9,2,2); }
    if(t===T.LEVER){ cx.fillStyle='#444'; cx.fillRect(px+6,py+6,4,8); cx.fillStyle='#cfa85b'; cx.fillRect(px+5,py+5,6,2); }
    if(t===T.TORCH){ cx.fillStyle='#3a2a12'; cx.fillRect(px+6,py+4,4,10); cx.fillStyle=Math.random()>.5?css('--torch'):css('--torch2'); cx.fillRect(px+6,py+2,4,3); }
    if(t===T.DOOR){ cx.fillStyle='#231a12'; cx.fillRect(px,py,TILE,TILE); cx.fillStyle='#5a3a20'; cx.fillRect(px+4,py+2,8,12); }
    if(t===T.ANVIL){ cx.fillStyle='#2e2f38'; cx.fillRect(px+4,py+8,8,6); cx.fillStyle='#4a4b58'; cx.fillRect(px+3,py+6,10,3); }
    if(t===T.TRADER){ cx.fillStyle='#113015'; cx.fillRect(px,py,TILE,TILE); cx.fillStyle='#cfa85b'; cx.fillRect(px+5,py+6,6,6); }
  }

  // player ‚Äúblocky human‚Äù
  const ppX=W/2, ppY=H/2;
  cx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--bone');
  cx.fillRect(ppX-4,ppY-6,8,10); cx.fillStyle='#9d9b90'; cx.fillRect(ppX-4,ppY-8,8,3);

  // entities
  ents.forEach(e=>{
    const ex=e.x*TILE - camX, ey=e.y*TILE - camY;
    if(e.enemy){
      if(e.kind==='skeleton'){ cx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--bone'); cx.fillRect(ex-4,ey-6,8,10); cx.fillStyle='#555'; cx.fillRect(ex-4,ey-8,8,3); }
      else if(e.kind==='slime'){ cx.fillStyle='#233'; cx.fillRect(ex-5,ey-4,10,8); cx.fillStyle='#355'; cx.fillRect(ex-5,ey-6,10,2); }
      else if(e.kind==='archer'){ cx.fillStyle='#d2c9b8'; cx.fillRect(ex-4,ey-6,8,10); cx.fillStyle='#4a3a2a'; cx.fillRect(ex-4,ey-8,8,3); cx.fillStyle='#885522'; cx.fillRect(ex+3,ey-2,2,6); }
      else if(e.kind==='bat'){ cx.fillStyle='#2a2a33'; cx.fillRect(ex-3,ey-3,6,6); cx.fillRect(ex-7,ey-1,4,2); cx.fillRect(ex+3,ey-1,4,2); }
      else if(e.kind==='brute'){ cx.fillStyle='#4b2a2f'; cx.fillRect(ex-7,ey-7,14,14); cx.fillStyle='#8c3a45'; cx.fillRect(ex-7,ey-9,14,3); }
    } else {
      if(e.kind==='bolt'){ cx.fillStyle='#bcd1ff'; cx.fillRect(ex-1,ey-1,2,2); }
      if(e.kind==='loot'){ cx.fillStyle=e.col||'#ffd26a'; cx.fillRect(ex-3,ey-3,6,6); }
    }
  });

  // vignette
  cx.globalAlpha=.55; const g=cx.createRadialGradient(W/2,H/2,W*.25,W/2,H/2,W*.75);
  g.addColorStop(0,'rgba(0,0,0,0)'); g.addColorStop(1,'rgba(0,0,0,1)'); cx.fillStyle=g; cx.fillRect(0,0,W,H); cx.globalAlpha=1;
}

/* ---------- inventory / panel ---------- */
const panel=document.getElementById('panel'), panelC=document.getElementById('panelC');
function openPanel(html,choices){ panelC.innerHTML=html+(choices?`<div class="choices">${choices.map((c,i)=>`<button class="choice">${c.label}</button>`).join('')}</div>`:''); panel.style.display='flex'; if(choices){ panelC.querySelectorAll('.choice').forEach((b,i)=>b.onclick=()=>{panel.style.display='none';choices[i].on();}); } else panel.onclick=()=>panel.style.display='none'; }
const ITICON=w=>w==='food'?'üçó':w==='sword'?'üó°Ô∏è':w==='xbow'?'üèπ':w==='pot'?'üß™':w==='shield'?'üõ°Ô∏è':w==='relic'?'‚ú®':'‚Ä¢';
function giveItem(what,opt={}){ player.inv.push({what,...opt}); toast(`Got ${what}`); SFX.pick(); }
function openInventory(){ const grid=player.inv.map(it=>`<div class="slot">${ITICON(it.what)}</div>`).join(''); openPanel(`<h3>Inventory</h3><div id="invGrid">${grid}</div><p>Tap a slot to use/equip.</p>`); panelC.querySelectorAll('.slot').forEach((n,i)=>n.onclick=()=>{ useItem(i); panel.style.display='none'; }); }
function useItem(i){ const it=player.inv[i]; if(!it) return; if(it.what==='food'){ player.hunger=player.hungerMax; SFX.heal(); } if(it.what==='sword'){ equipSword(30); } if(it.what==='xbow'){ equipBow(20); } if(it.what==='shield'){ player.shield=(player.shield||0)+3; } if(it.what==='pot'){ const r=rint(0,4); if(r===0) player.spd=player.base+1.2, setTimeout(()=>player.spd=player.base,20000); if(r===1) player.hp=Math.min(player.hpMax,player.hp+2); if(r===2) player.energy=player.energyMax; if(r===3) player.hunger=player.hungerMax; if(r===4) player.melee && (player.meleeDur+=10); } if(it.what==='relic'){ player.melee=true; player.meleeDur=999999; player.ranged=true; player.rangedDur=999999; } player.inv.splice(i,1); bars(); }

/* ---------- combat / AI ---------- */
function melee(){ SFX.hit(); const dmg=player.melee?2:1; ents.forEach(e=>{ if(e.enemy && Math.hypot(e.x-player.x,e.y-player.y)<1.2){ e.hp-=dmg; if(e.hp<=0) die(e); } }); if(player.melee && player.meleeDur<999999){ if(--player.meleeDur<=0){ player.melee=false; toast('Sword broke'); } } }
function ranged(){ if(!player.ranged){ toast('No crossbow yet'); return; } let best=null,bd=999; ents.forEach(e=>{ if(e.enemy){ const d=Math.hypot(e.x-player.x,e.y-player.y); if(d>=5 && d<bd){ bd=d; best=e; } } }); if(!best){ toast('Must be ‚â•5 tiles away'); return; } const a=Math.atan2(best.y-player.y,best.x-player.x); ents.push({kind:'bolt',x:player.x,y:player.y,vx:Math.cos(a)*0.5,vy:Math.sin(a)*0.5,ttl:240,dmg:3}); if(player.rangedDur<999999){ if(--player.rangedDur<=0){ player.ranged=false; toast('Crossbow snapped'); } } }
function doDash(){ if(player.dashCd>0||player.energy<20){ toast('Dash cooling / tired'); return; } SFX.dash(); const dir=player.face[0]||player.face[1]?player.face:[1,0]; const tx=player.x+dir[0]*1.6,ty=player.y+dir[1]*1.6; if(walkable(Math.round(tx),Math.round(player.y))) player.x=tx; if(walkable(Math.round(player.x),Math.round(ty))) player.y=ty; ents.forEach(e=>{ if(e.enemy && Math.hypot(e.x-player.x,e.y-player.y)<1.2){ e.hp-=2; if(e.hp<=0) die(e); }}); player.energy=Math.max(0,player.energy-20); player.dashCd=900; }
function die(e){ let c=1; if(e.kind==='skeleton')c=2; if(e.kind==='archer')c=3; if(e.kind==='brute')c=4; coins+=c; SFX.coin(); if(chance(.1)) ents.push({kind:'loot',what:'pot',col:'#b98cff',x:e.x,y:e.y,ttl:8000}); e.enemy=false; e.dead=true; }
function ai(dt){ ents.forEach(e=>{ if(e.enemy){ const dx=player.x-e.x,dy=player.y-e.y,d=Math.hypot(dx,dy)||1, sp=e.spd*dt/220, nx=e.x+dx/d*sp, ny=e.y+dy/d*sp; if(walkable(Math.round(nx),Math.round(e.y))) e.x=nx; if(walkable(Math.round(e.x),Math.round(ny))) e.y=ny; e.cd-=dt; if(e.ranged && e.cd<=0 && d>4){ const a=Math.atan2(dy,dx); ents.push({kind:'bolt',x:e.x,y:e.y,vx:Math.cos(a)*0.35,vy:Math.sin(a)*0.35,ttl:240,dmg:1}); e.cd=1100; } if(d<0.9 && e.cd<=0){ damage(1); e.cd=900; } } else { if(e.kind==='bolt'){ e.x+=e.vx*dt; e.y+=e.vy*dt; e.ttl-=dt; if(Math.hypot(player.x-e.x,player.y-e.y)<0.7 && e.dmg){ damage(e.dmg); e.ttl=0; } ents.forEach(t=>{ if(t.enemy && Math.hypot(t.x-e.x,t.y-e.y)<0.6){ t.hp-=e.dmg; e.ttl=0; if(t.hp<=0) die(t);} }); if(e.ttl<=0) e.dead=true; } if(e.kind==='loot'){ e.ttl-=dt; if(e.ttl<=0) e.dead=true; if(Math.hypot(e.x-player.x,e.y-player.y)<0.7){ giveItem(e.what); e.dead=true; } } } }); ents=ents.filter(e=>!e.dead); }
function damage(n){ if(player.shield>0){player.shield--;return;} player.hp=Math.max(0,player.hp-n); SFX.hurt(); }

/* ---------- interact ---------- */
function interact(){ const px=Math.round(player.x), py=Math.round(player.y); let did=false; for(let y=py-1;y<=py+1;y++)for(let x=px-1;x<=px+1;x++){ const t=tileAt(x,y); if(t===T.LEVER){ map[y][x]=T.FLOOR; for(let yy=1;yy<RH-1;yy++)for(let xx=1;xx<RW-1;xx++) if(map[yy][xx]===T.SECRETD){ map[yy][xx]=T.FLOOR; toast('Stone slides‚Ä¶'); did=true; break; } if(!did) toast('The lever clanks.'); did=true; } else if(t===T.CHEST){ openChest(); map[y][x]=T.FLOOR; did=true; } else if(t===T.SECRETD){ map[y][x]=T.FLOOR; toast('Hidden seam opens'); did=true; } else if(t===T.TRADER){ openTrader(); did=true; } else if(t===T.ANVIL){ openAnvil(); did=true; } else if(t===T.POOL){ player.hp=player.hpMax; player.hunger=player.hungerMax; player.energy=player.energyMax; SFX.heal(); toast('You feel renewed'); did=true; } } if(!did) toast("There's nothing there"); }
function openChest(){ const r=Math.random(); if(r<.35) giveItem('food'); else if(r<.55) giveItem('sword'); else if(r<.7) giveItem('xbow'); else if(r<.85) giveItem('pot'); else giveItem('shield'); }
function openTrader(){ const trades=[{label:'Buy Sword (ü™ô 8)', cost:8, give:'sword'},{label:'Buy Crossbow (ü™ô 10)', cost:10, give:'xbow'},{label:'Buy Potion (ü™ô 5)', cost:5, give:'pot'},{label:'Sell Food (ü™ô +2)', sell:'food', gain:2},{label:'Sell Shield (ü™ô +4)', sell:'shield', gain:4}]; openPanel(`<h3>Wandering Trader</h3><p>Coins: ${coins}</p>`, trades.map(t=>({label:t.label,on:()=>{ if(t.give){ if(coins>=t.cost){ coins-=t.cost; giveItem(t.give); } else toast('Not enough coins'); } else { const idx=player.inv.findIndex(i=>i.what===t.sell); if(idx>-1){ player.inv.splice(idx,1); coins+=t.gain; SFX.coin(); } else toast('You lack that item'); } bars(); }}))); }
function openAnvil(){ openPanel(`<h3>Smith‚Äôs Anvil</h3><p style="background:#0b0b0e;border:1px solid #2b2b33;padding:.5rem;border-radius:8px">Choose your path:</p>`,[{label:`A) üó°Ô∏è Sword ‚Äî +2 dmg, durability 40`,on:()=>{giveItem('sword');}},{label:`B) üèπ Crossbow ‚Äî fast draw, durability 25`,on:()=>{giveItem('xbow');}}]); }

/* ---------- HUD ---------- */
function bars(){ hpVal.textContent=Math.round(player.hp); hpF.style.width=(player.hp/player.hpMax*100)+'%'; enF.style.width=(player.energy/player.energyMax*100)+'%'; huF.style.width=(player.hunger/player.hungerMax*100)+'%'; roomT.textContent='Room '+room; coinsT.textContent='ü™ô '+coins; }

/* ---------- loop ---------- */
let last=performance.now();
function tick(){
  const t=performance.now(), dt=Math.min(60,t-last); last=t;

  // survival
  player.hunger=Math.max(0, player.hunger - dt/60000*10);
  const onPool=tileAt(Math.round(player.x),Math.round(player.y))===T.POOL;
  player.energy=clamp(player.energy+(onPool?0.5:0.08)*dt,0,player.energyMax);
  if(player.hunger>=player.hungerMax-0.1 && player.hp<player.hpMax){ player.hp=Math.min(player.hpMax, player.hp+dt/1500); }
  if(player.dashCd>0) player.dashCd-=dt;

  // D‚Äëpad movement
  let mx=(held.right?1:0)-(held.left?1:0), my=(held.down?1:0)-(held.up?1:0);
  if(mx||my){
    const len=Math.hypot(mx,my)||1; mx/=len; my/=len; player.face=[mx,my];
    const sp=player.spd*(player.energy<=0?0.5:1);
    const nx=player.x+mx*sp*dt/160, ny=player.y+my*sp*dt/160;
    if(walkable(Math.round(nx),Math.round(player.y))) player.x=nx;
    if(walkable(Math.round(player.x),Math.round(ny))) player.y=ny;
  }

  // door ‚Üí next room
  const tx=Math.round(player.x), ty=Math.round(player.y); if(tileAt(tx,ty)===T.DOOR){ room++; regen(); toast('Room '+room); }

  ai(dt);
  drawWorld(); bars();

  if(player.hp<=0){ openPanel(`<h3 style="color:#ff9aa2">You fell in the dark</h3><p>Rooms cleared: ${room-1}</p>`,[{label:'Retry',on:()=>{ room=1; coins=0; Object.assign(player,{hp:10,hunger:10,energy:100,inv:[],melee:false,ranged:false}); regen(); panel.style.display='none'; }}]); return; }
  requestAnimationFrame(tick);
}

/* ---------- start ---------- */
window.addEventListener('load', ()=>{ regen(); requestAnimationFrame(tick); });
cv.addEventListener('pointerdown', function once(){ try{SFX.start();}catch{} cv.removeEventListener('pointerdown', once); }, {passive:true});
hpVal.textContent='10';
</script>
</body>
</html>
